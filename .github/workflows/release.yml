name: Release to Play Store

on:
  workflow_dispatch:
    inputs:
      track:
        description: 'Play Store track'
        required: true
        default: 'internal'
        type: choice
        options:
          - internal
          - alpha
          - beta
          - production

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    name: Build & Release
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for release notes
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false
          cache-cleanup: on-success
      
      - name: Validate required secrets
        shell: bash
        run: |
          MISSING_SECRETS=""
          
          if [ -z "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" ]; then
            MISSING_SECRETS="$MISSING_SECRETS RELEASE_KEYSTORE_BASE64"
          fi
          if [ -z "${{ secrets.RELEASE_KEYSTORE_PASSWORD }}" ]; then
            MISSING_SECRETS="$MISSING_SECRETS RELEASE_KEYSTORE_PASSWORD"
          fi
          if [ -z "${{ secrets.RELEASE_KEY_ALIAS }}" ]; then
            MISSING_SECRETS="$MISSING_SECRETS RELEASE_KEY_ALIAS"
          fi
          if [ -z "${{ secrets.RELEASE_KEY_PASSWORD }}" ]; then
            MISSING_SECRETS="$MISSING_SECRETS RELEASE_KEY_PASSWORD"
          fi
          if [ -z "${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON }}" ]; then
            MISSING_SECRETS="$MISSING_SECRETS PLAY_STORE_SERVICE_ACCOUNT_JSON"
          fi
          
          if [ -n "$MISSING_SECRETS" ]; then
            echo "âŒ Missing required secrets:$MISSING_SECRETS"
            echo "Please configure these secrets in GitHub Settings -> Secrets and variables -> Actions"
            echo "See docs/github_secrets_setup.md for details"
            exit 1
          fi
          
          echo "âœ… All required secrets are configured"
      
      - name: Make scripts executable
        run: chmod +x ./gradlew ./scripts/bump-version-code.sh
      
      - name: Bump versionCode
        id: bump_version
        run: |
          ./scripts/bump-version-code.sh
          NEW_VERSION=$(grep -E '^\s*versionCode\s*=\s*[0-9]+' app/build.gradle.kts | sed -E 's/.*versionCode\s*=\s*([0-9]+).*/\1/')
          VERSION_NAME=$(grep -E '^\s*versionName\s*=\s*"[^"]+"' app/build.gradle.kts | sed -E 's/.*versionName\s*=\s*"([^"]+)".*/\1/')
          echo "version_code=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION_NAME ($NEW_VERSION)"
      
      - name: Decode keystore
        run: |
          echo "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" | base64 -d > app/release-keystore.jks
      
      - name: Create google-services.json from secrets
        run: echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > app/google-services.json
      
      - name: Create Play Store service account JSON
        run: echo '${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON }}' > app/play-store-credentials.json
      
      - name: Build release bundle
        env:
          RELEASE_KEYSTORE_PATH: ${{ github.workspace }}/app/release-keystore.jks
          RELEASE_KEYSTORE_PASSWORD: ${{ secrets.RELEASE_KEYSTORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
        run: |
          # Create temporary local.properties with signing config
          cat > local.properties << EOF
          RELEASE_KEYSTORE_PATH=$RELEASE_KEYSTORE_PATH
          RELEASE_KEYSTORE_PASSWORD=$RELEASE_KEYSTORE_PASSWORD
          RELEASE_KEY_ALIAS=$RELEASE_KEY_ALIAS
          RELEASE_KEY_PASSWORD=$RELEASE_KEY_PASSWORD
          EOF
          
          # Build the release bundle
          ./gradlew bundleRelease --stacktrace
      
      - name: Generate release notes
        id: release_notes
        run: |
          # Get the last tag (if any)
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            echo "ðŸ“ First release - generating notes from all commits"
            NOTES=$(git log --pretty=format:"- %s" --no-merges | head -20)
          else
            echo "ðŸ“ Generating notes since $LAST_TAG"
            NOTES=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s" --no-merges)
          fi
          
          # Fallback if no new commits
          if [ -z "$NOTES" ]; then
            NOTES="- No new changes since last release"
          fi
          
          # Create release notes file
          cat > release-notes.txt << EOF
          Release ${{ steps.bump_version.outputs.version_name }} (Build ${{ steps.bump_version.outputs.version_code }})
          
          What's New:
          $NOTES
          
          Generated from commits since last release.
          EOF
          
          echo "Release notes:"
          cat release-notes.txt
          
          # Save for later steps (escape newlines for GitHub Actions)
          {
            echo 'notes<<EOF'
            cat release-notes.txt
            echo 'EOF'
          } >> $GITHUB_OUTPUT
      
      - name: Upload to Play Store
        run: |
          ./gradlew publishBundle \
            --track=${{ inputs.track }} \
            --stacktrace
      
      - name: Create release tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          TAG_NAME="v${{ steps.bump_version.outputs.version_name }}-build.${{ steps.bump_version.outputs.version_code }}"
          
          git tag -a "$TAG_NAME" -m "Release ${{ steps.bump_version.outputs.version_name }} (Build ${{ steps.bump_version.outputs.version_code }})"
          git push origin "$TAG_NAME"
          
          echo "âœ… Created and pushed tag: $TAG_NAME"
      
      - name: Create version bump PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: Bump versionCode to ${{ steps.bump_version.outputs.version_code }}"
          branch: release/version-bump-${{ steps.bump_version.outputs.version_code }}
          delete-branch: true
          title: "chore: Bump versionCode to ${{ steps.bump_version.outputs.version_code }}"
          body: |
            Automated version bump after release to Play Store.
            
            **Release Details:**
            - Version: ${{ steps.bump_version.outputs.version_name }}
            - Build: ${{ steps.bump_version.outputs.version_code }}
            - Track: ${{ inputs.track }}
            - Tag: v${{ steps.bump_version.outputs.version_name }}-build.${{ steps.bump_version.outputs.version_code }}
            
            **Release Notes:**
            ```
            ${{ steps.release_notes.outputs.notes }}
            ```
            
            This PR updates the versionCode in source control to match the Play Store release.
          labels: |
            release
            automated
      
      - name: Upload bundle artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: release-bundle
          path: app/build/outputs/bundle/release/*.aab
          retention-days: 30
      
      - name: Cleanup sensitive files
        if: always()
        run: |
          rm -f app/release-keystore.jks
          rm -f app/play-store-credentials.json
          rm -f app/google-services.json
          rm -f local.properties
      
      - name: Release summary
        run: |
          echo "# ðŸš€ Release Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.bump_version.outputs.version_name }} (Build ${{ steps.bump_version.outputs.version_code }})" >> $GITHUB_STEP_SUMMARY
          echo "**Track:** ${{ inputs.track }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** v${{ steps.bump_version.outputs.version_name }}-build.${{ steps.bump_version.outputs.version_code }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Release Notes" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat release-notes.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
